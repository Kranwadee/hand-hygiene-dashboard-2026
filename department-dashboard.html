<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Dashboard - Hand Hygiene</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    <style>
        :root {
            --primary-green: #059669;
            --secondary-green: #10b981;
            --accent-green: #34d399;
            --bg-canvas: #f0fdf4;
            --card-white: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --danger: #f43f5e;
            --success: #10b981;
            --warning: #f59e0b;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* =========================================
           GLOBAL STYLES
           ========================================= */
        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-canvas);
            color: var(--text-main);
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
        }

        /* =========================================
           LOGIN SCREEN STYLES (Green Theme)
           ========================================= */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #059669 0%, #10b981 30%, #34d399 70%, #6ee7b7 100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            overflow: hidden;
        }

        /* Animated Particles */
        .login-container::before {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            top: -100px;
            right: -100px;
            animation: float 8s ease-in-out infinite;
        }

        .login-container::after {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 70%);
            bottom: -50px;
            left: -50px;
            animation: float 10s ease-in-out infinite reverse;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 50px 40px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2) inset;
            max-width: 420px;
            width: 100%;
            position: relative;
            z-index: 10;
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #059669, #10b981);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            font-size: 36px;
            color: white;
            box-shadow: 0 15px 40px rgba(5, 150, 105, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .login-card h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 8px;
            text-align: center;
        }

        .login-card p {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 30px;
            text-align: center;
        }

        .login-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            font-size: 16px;
            font-family: 'Prompt', sans-serif;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .login-input:focus {
            outline: none;
            border-color: #10b981;
            background: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
        }

        /* Password Input Container */
        .password-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }

        .password-container .login-input {
            margin-bottom: 0;
            padding-right: 50px;
        }

        .toggle-password {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            transition: color 0.3s ease;
        }

        .toggle-password:hover {
            color: #10b981;
        }

        .login-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Prompt', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-button:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(5, 150, 105, 0.4);
        }

        .login-hint {
            margin-top: 25px;
            padding: 18px;
            background: #f0fdf4;
            border-radius: 14px;
            font-size: 13px;
            color: #047857;
            border: 1px solid #bbf7d0;
            text-align: center;
        }

        .back-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            padding: 14px;
            color: #059669;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid #d1fae5;
            border-radius: 14px;
            transition: all 0.3s ease;
            background: #ecfdf5;
        }

        .back-link:hover {
            background: #d1fae5;
            border-color: #10b981;
        }

        .error-message {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        #dashboardContent {
            display: none;
        }

        /* Dashboard Container */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* Header */
        .header-section {
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
            color: white;
            padding: 25px 40px;
            border-radius: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-xl);
        }

        .header-section h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header-section p {
            font-size: 13px;
            opacity: 0.95;
        }

        /* Navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 10px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 18px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Prompt', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-back {
            background: linear-gradient(135deg, #0ea5e9, #38bdf8);
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .btn-back:hover {
            background: linear-gradient(135deg, #0284c7, #0ea5e9);
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.5);
        }

        .btn-home {
            background: white;
            border: 2px solid var(--danger);
            color: var(--danger);
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.2);
        }

        .btn-home:hover {
            background: var(--danger);
            color: white;
            box-shadow: 0 8px 24px rgba(244, 63, 94, 0.4);
        }

        .btn-logout {
            background: var(--danger);
            color: white;
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3);
        }

        .btn-logout:hover {
            background: #dc2626;
            box-shadow: 0 8px 24px rgba(244, 63, 94, 0.5);
        }

        /* Top Navigation Bar */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 15px;
            background-color: transparent;
            box-shadow: none;
            border: none;
        }

        /* KPI Cards */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-box {
            background: var(--card-white);
            padding: 30px 24px;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .kpi-box:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-green);
        }

        .kpi-label {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-main);
            text-transform: capitalize;
            letter-spacing: 0.3px;
        }

        .kpi-value {
            font-family: 'Outfit', sans-serif;
            font-size: 38px;
            font-weight: 700;
            color: var(--primary-green);
            margin: 10px 0;
        }

        .kpi-sub {
            font-size: 12px;
            color: var(--text-sub);
        }

        /* Main Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-col {
            width: 100%;
            background: white;
            padding: 30px;
            border-radius: 28px;
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-md);
        }

        /* Hand Visualization - Prominent Full-Width Card */
        .hand-prominent-card {
            width: 100%;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fffbeb 100%);
            padding: 30px;
            border-radius: 28px;
            border: 3px solid #f59e0b;
            box-shadow: 0 8px 32px rgba(245, 158, 11, 0.2), 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .hand-prominent-card:hover {
            box-shadow: 0 12px 40px rgba(245, 158, 11, 0.3), 0 6px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        /* Hand Visualization */
        .hand-viz-grid {
            display: flex;
            justify-content: center;
            gap: 60px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.7);
            padding: 30px 20px;
            border-radius: 20px;
            margin-top: 20px;
        }

        .hand-view {
            text-align: center;
        }

        .hand-svg {
            width: 220px;
            max-width: 220px;
            height: auto;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.06));
        }

        .hand-path {
            fill: #f1f5f9;
            stroke: #cbd5e1;
            stroke-width: 1.5;
        }

        .heat-glow {
            filter: blur(10px);
            animation: pulse-heat 2s infinite alternate ease-in-out;
            mix-blend-mode: multiply;
            pointer-events: none;
        }

        @keyframes pulse-heat {
            from {
                opacity: 0.4;
                transform: scale(0.98);
            }

            to {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        /* Interactive Zone Styles - Hospital Dashboard Style */
        .interactive-zone {
            cursor: pointer;
            transition: all 0.3s;
            stroke: transparent;
            stroke-width: 15px;
        }

        .interactive-zone:hover {
            stroke: rgba(245, 158, 11, 0.5);
            stroke-width: 4px;
        }

        /* Hand Tooltip Styles - Hospital Dashboard Style */
        .hand-tooltip {
            position: absolute;
            background: #0f172a;
            color: white;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 9999;
            transform: translate(-50%, -100%);
            margin-top: -10px;
            white-space: nowrap;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .hand-tooltip.visible {
            opacity: 1;
        }

        /* Comparison Card */
        .comparison-card {
            background: white;
            padding: 30px;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-item {
            text-align: center;
            padding: 20px;
            background: #f0fdf4;
            border-radius: 16px;
        }

        .comparison-item .label {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 10px;
        }

        .comparison-item .value {
            font-family: 'Outfit', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-green);
        }

        .comparison-item .diff {
            font-size: 13px;
            font-weight: 700;
            margin-top: 5px;
        }

        .comparison-item .diff.positive {
            color: var(--success);
        }

        .comparison-item .diff.negative {
            color: var(--danger);
        }

        /* Ranking Table */
        .table-section {
            background: white;
            padding: 30px;
            border-radius: 28px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 15px;
            color: var(--text-sub);
            font-size: 11px;
            text-transform: uppercase;
            border-bottom: 2px solid #f1f5f9;
        }

        td {
            padding: 18px 15px;
            font-size: 14px;
            border-bottom: 1px solid #f8fafc;
        }

        tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f1f5f9;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 11px;
        }

        .bg-success {
            background: #dcfce7;
            color: #15803d;
        }

        .bg-danger {
            background: #fee2e2;
            color: #be123c;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .login-card {
                padding: 30px 20px;
            }

            .header-section {
                padding: 20px;
                text-align: center;
            }

            .header-section h1 {
                font-size: 20px;
                line-height: 1.3;
            }

            .top-nav {
                flex-direction: column;
                gap: 10px;
            }

            .nav-actions {
                width: 100%;
                justify-content: center;
            }

            .btn {
                width: 100%;
                justify-content: center;
                font-size: 12px;
            }

            .kpi-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .kpi-box {
                padding: 20px;
            }

            .kpi-label {
                font-size: 12px;
            }

            .kpi-value {
                font-size: 32px;
            }

            .content-grid {
                flex-direction: column;
            }

            .hand-col {
                min-width: 100%;
            }

            .chart-col {
                padding: 20px;
            }

            .hand-viz-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .hand-svg {
                max-width: 140px;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .table-section {
                padding: 15px;
                overflow-x: auto;
            }

            table {
                font-size: 11px;
                min-width: 600px;
            }

            th,
            td {
                padding: 10px 8px;
                font-size: 11px;
            }

            .status-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .kpi-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .content-grid {
                flex-direction: column;
            }

            .hand-col {
                min-width: 100%;
            }
        }

        /* Motivation Banner Styles - Premium 5-Level Design */
        .motivation-banner {
            padding: 18px 28px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 17px;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.25), 0 4px 10px -3px rgba(0, 0, 0, 0.1);
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
        }

        .motivation-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.7);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            50%,
            100% {
                left: 100%;
            }
        }

        @keyframes pulse-critical {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 10px 25px -5px rgba(220, 38, 38, 0.5), 0 4px 10px -3px rgba(0, 0, 0, 0.1);
            }

            50% {
                opacity: 0.9;
                box-shadow: 0 15px 35px -5px rgba(220, 38, 38, 0.7), 0 6px 15px -3px rgba(0, 0, 0, 0.15);
            }
        }

        /* 5-Level Gradient System */
        .motivation-emerald {
            background: linear-gradient(135deg, #34d399, #059669);
        }

        .motivation-ocean {
            background: linear-gradient(135deg, #38bdf8, #0284c7);
        }

        .motivation-amber {
            background: linear-gradient(135deg, #fbbf24, #d97706);
        }

        .motivation-orange {
            background: linear-gradient(135deg, #fb923c, #ea580c);
        }

        .motivation-crimson {
            background: linear-gradient(135deg, #f87171, #dc2626);
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55), pulse-critical 2s ease-in-out infinite;
        }

        .banner-main-text {
            font-size: 17px;
            font-weight: 700;
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-icon">
                <i class="fa-solid fa-users"></i>
            </div>
            <h1>Department Dashboard Login</h1>
            <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Employee ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Enter Employee ID to view your department data)</p>

            <div class="error-message" id="errorMessage">
                <i class="fa-solid fa-circle-exclamation"></i>
                <span>‡πÑ‡∏°‡πà‡∏û‡∏ö Employee ID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (Employee ID not found, please try again)</span>
            </div>

            <div class="password-container">
                <input type="text" id="empIdInput" class="login-input" placeholder="Employee ID (‡πÄ‡∏ä‡πà‡∏ô EMP001)"
                    autocomplete="off">
            </div>

            <button class="login-button" onclick="handleLogin()">
                <i class="fa-solid fa-arrow-right-to-bracket"></i>
                <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)</span>
            </button>

            <div class="login-hint">
                <i class="fa-solid fa-info-circle"></i>
                <strong>Demo IDs:</strong> EMP001 (ER), EMP015 (ICU), EMP030 (OR), EMP045 (Ward)
            </div>

            <a href="index.html" class="back-link">
                <i class="fa-solid fa-arrow-left"></i>
                <span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (Back to Home)</span>
            </a>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent">

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="dashboard-container">
            <!-- Top Navigation -->
            <nav class="top-nav">
                <div id="backButtonContainer" style="display: none;">
                    <button class="btn btn-back" onclick="location.href='hospital-dashboard.html'">
                        <i class="fa-solid fa-arrow-left"></i> <span>‡∏Å‡∏•‡∏±‡∏ö IC Dashboard (Back to IC Dashboard)</span>
                    </button>
                </div>
                <div style="flex: 1;"></div>
                <button class="btn btn-logout" onclick="handleLogout()">
                    <i class="fa-solid fa-right-from-bracket"></i> <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Logout)</span>
                </button>
            </nav>

            <!-- Header -->
            <header class="header-section">
                <h1 id="deptName">‡πÅ‡∏ú‡∏ô‡∏Å ER (Emergency Room)</h1>
                <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Your Department Hand Hygiene Data) | 30-31 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2568</p>
            </header>

            <!-- Motivation Banner -->
            <div id="motivationBanner" class="motivation-banner motivation-improve">
                <span class="emoji-icon">üìâ</span>
                <span>‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏Å‡πÑ‡∏õ‡∏ô‡∏¥‡∏î ‚Äî ‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞! üò∑‚ù§Ô∏è</span>
            </div>

            <!-- Hand Visualization - Prominent Full-Width Card (MOVED HERE) -->
            <div class="hand-prominent-card" id="handProminentCard" style="position: relative;">
                <h3
                    style="font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 20px; text-align: center;">
                    <i class="fa-solid fa-hand-dots" style="color: #f59e0b;"></i>
                    <span data-translate="header-11-zone">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Frequent Unclean Zones)</span>
                </h3>

                <!-- Hand Tooltip -->
                <div id="handTooltip" class="hand-tooltip"></div>

                <div class="hand-viz-grid">
                    <div class="hand-view">
                        <p style="font-size: 12px; font-weight: 800; margin-bottom: 12px; color: var(--primary-green);">
                            ‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏≠ (Palm)</p>
                        <svg class="hand-svg" viewBox="0 0 200 250">
                            <path class="hand-path"
                                d="M100 240 Q70 240 55 210 Q45 190 40 160 Q30 150 15 110 Q5 90 15 70 Q25 50 35 60 L45 90 L40 30 Q40 10 55 10 Q70 10 70 40 L75 95 L85 15 Q85 -5 100 -5 Q115 -5 115 25 L115 95 L125 20 Q125 0 140 0 Q155 0 155 30 L155 100 L165 50 Q165 35 180 35 Q195 35 185 80 Q175 120 180 160 Q180 200 160 230 Q140 240 100 240 Z" />
                            <!-- Heat Glow Effects -->
                            <circle class="heat-glow" cx="100" cy="170" r="40" fill="var(--danger)" id="heatPalm" />
                            <circle class="heat-glow" cx="60" cy="180" r="25" fill="var(--danger)" id="heatPaw" />
                            <circle class="heat-glow" cx="25" cy="110" r="18" fill="var(--danger)" id="heatThumbs" />
                            <!-- Interactive Zones -->
                            <circle class="interactive-zone" cx="100" cy="170" r="40" fill="transparent"
                                data-zone="Palm ‡∏ù‡πà‡∏≤‡∏°‡∏∑‡∏≠" />
                            <circle class="interactive-zone" cx="60" cy="180" r="25" fill="transparent"
                                data-zone="Paw ‡∏≠‡∏∏‡πâ‡∏á‡∏°‡∏∑‡∏≠" />
                            <circle class="interactive-zone" cx="25" cy="110" r="18" fill="transparent"
                                data-zone="Thumbs ‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á" />
                            <circle class="interactive-zone" cx="50" cy="30" r="18" fill="transparent"
                                data-zone="Pointer ‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏µ‡πâ" />
                            <circle class="interactive-zone" cx="100" cy="20" r="18" fill="transparent"
                                data-zone="Middle ‡∏ô‡∏¥‡πâ‡∏ß‡∏Å‡∏•‡∏≤‡∏á" />
                        </svg>
                        <div style="font-size: 16px; font-weight: 800; color: var(--danger); margin-top:10px;">‡∏´‡∏ô‡πâ‡∏≤:
                            <span id="frontAvg">0</span>%
                        </div>
                    </div>
                    <div class="hand-view">
                        <p style="font-size: 12px; font-weight: 800; margin-bottom: 12px; color: var(--primary-green);">
                            ‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠ (Back)</p>
                        <svg class="hand-svg" viewBox="0 0 200 250">
                            <path class="hand-path"
                                d="M100 240 Q70 240 55 210 Q45 190 40 160 Q30 150 15 110 Q5 90 15 70 Q25 50 35 60 L45 90 L40 30 Q40 10 55 10 Q70 10 70 40 L75 95 L85 15 Q85 -5 100 -5 Q115 -5 115 25 L115 95 L125 20 Q125 0 140 0 Q155 0 155 30 L155 100 L165 50 Q165 35 180 35 Q195 35 185 80 Q175 120 180 160 Q180 200 160 230 Q140 240 100 240 Z" />
                            <!-- Heat Glow Effects -->
                            <rect class="heat-glow" x="60" y="140" width="80" height="50" rx="20" fill="var(--danger)"
                                id="heatBackhand" />
                            <rect class="heat-glow" x="75" y="85" width="50" height="15" rx="5" fill="var(--danger)"
                                id="heatBetween" />
                            <circle class="heat-glow" cx="100" cy="15" r="20" fill="var(--danger)" id="heatNails" />
                            <!-- Interactive Zones -->
                            <rect class="interactive-zone" x="60" y="140" width="80" height="50" rx="20"
                                fill="transparent" data-zone="Backhand ‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠" />
                            <rect class="interactive-zone" x="75" y="85" width="50" height="15" rx="5"
                                fill="transparent" data-zone="Between ‡∏ã‡∏≠‡∏Å‡∏ô‡∏¥‡πâ‡∏ß" />
                            <circle class="interactive-zone" cx="100" cy="15" r="20" fill="transparent"
                                data-zone="Nails ‡πÄ‡∏•‡πá‡∏ö" />
                            <circle class="interactive-zone" cx="180" cy="180" r="18" fill="transparent"
                                data-zone="Pinky ‡∏ô‡∏¥‡πâ‡∏ß‡∏Å‡πâ‡∏≠‡∏¢" />
                        </svg>
                        <div style="font-size: 16px; font-weight: 800; color: var(--danger); margin-top:10px;">‡∏´‡∏•‡∏±‡∏á:
                            <span id="backAvg">0</span>%
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div
                    style="margin-top: 25px; padding: 18px; background: #f8fafc; border-radius: 12px; font-size: 13px; text-align: center; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div
                                style="width: 24px; height: 24px; background: #ef4444; border-radius: 50%; opacity: 0.9;">
                            </div>
                            <span style="color: #64748b; font-weight: 600;">‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 60% (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div
                                style="width: 24px; height: 24px; background: #f59e0b; border-radius: 50%; opacity: 0.7;">
                            </div>
                            <span style="color: #64748b; font-weight: 600;">60-79% (‡∏û‡∏≠‡πÉ‡∏ä‡πâ)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div
                                style="width: 24px; height: 24px; background: #10b981; border-radius: 50%; opacity: 0.5;">
                            </div>
                            <span style="color: #64748b; font-weight: 600;">80%+ (‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°)</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; border-top: 1px dashed #e2e8f0; padding-top: 10px;">
                        <span style="font-size: 11px; color: #64748b; font-style: italic;"><i
                                class="fa-solid fa-hand-pointer"></i> Hover ‡∏ö‡∏ô‡πÇ‡∏ã‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                    </div>
                </div>
            </div>

            <!-- KPI Row -->
            <div class="kpi-row">
                <div class="kpi-box">
                    <div class="kpi-label">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏Å (Department Average Score)</div>
                    <div class="kpi-value" id="deptAvg">0%</div>
                    <div class="kpi-sub">Department Average</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å (% Pass Rate within Dept)</div>
                    <div class="kpi-value" id="deptPass">12.5%</div>
                    <div class="kpi-sub">Compliance Rate</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠ (Total Washing Count)</div>
                    <div class="kpi-value" id="deptLogs">0</div>
                    <div class="kpi-sub">Total Records</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Status vs Target)</div>
                    <div class="kpi-value" id="deptStatus" style="font-size: 22px;">-</div>
                    <div class="kpi-sub">Target: 80%</div>
                </div>
            </div>


            <!-- Main Content Grid (Trend Chart Only) -->
            <div class="content-grid">
                <div class="chart-col">
                    <h3 style="font-size: 17px; font-weight: 700; color: var(--text-main); margin-bottom: 20px;">
                        <i class="fa-solid fa-chart-line" style="color: var(--primary-green);"></i>
                        <span data-translate="header-trend">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily Average Trend)</span>
                    </h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>


            <!-- Staff List Table -->
            <div class="table-section">
                <h3 style="font-size: 17px; font-weight: 700; color: var(--text-main); margin-bottom: 25px;">
                    <i class="fa-solid fa-users" style="color: var(--primary-green);"></i>
                    <span data-translate="header-ranking">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff List)</span> <span
                        style="font-size: 13px; color: var(--text-sub); font-style: italic;">(‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</span>
                </h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Name</th>
                                <th>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                <th>‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏≠</th>
                                <th>‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠</th>
                                <th>Logs</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- Staff rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // ============================================
            // DEPARTMENT NAME MAPPING
            // Maps various department names to database keys
            // ============================================
            const deptNameMapping = {
                // ER mappings
                'ER': 'ER',
                'er': 'ER',
                'Emergency': 'ER',
                'emergency': 'ER',
                'Emergency Room': 'ER',
                'emergency room': 'ER',
                '‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô': 'ER',
                '‡πÅ‡∏ú‡∏ô‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô': 'ER',

                // ICU mappings
                'ICU': 'ICU',
                'icu': 'ICU',
                'Intensive Care Unit': 'ICU',
                'intensive care unit': 'ICU',
                'ICUs': 'ICU',
                'ICUs 6': 'ICU',
                '‡πÑ‡∏≠‡∏ã‡∏µ‡∏¢‡∏π': 'ICU',

                // OR mappings
                'OR': 'OR',
                'or': 'OR',
                'Operating Room': 'OR',
                'operating room': 'OR',
                '‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î': 'OR',
                'Surgery': 'OR',

                // Ward mappings
                'Ward': 'Ward',
                'ward': 'Ward',
                'General Ward': 'Ward',
                'general ward': 'Ward',
                '‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢': 'Ward',

                // Additional department mappings for CSV data
                'Labour Room': 'Ward',
                'Nursery': 'Ward',
                'IPD Female': 'Ward',
                'IPD Male': 'Ward',
                'Pediatric': 'Ward',
                'OPD': 'ER',
                'Phlebotomy': 'Ward',
                'Dialysis': 'ICU',
                'NICU': 'ICU',
                'CCU': 'ICU',
                'Hr': 'Ward'
            };

            // ============================================
            // MOCK DATABASE WITH RICH DATA
            // ============================================
            const database = {
                users: {
                    'EMP001': { name: 'Dr. Somchai Ruangsri', dept: 'ER' },
                    'EMP002': { name: 'Nurse Pranee Sukjai', dept: 'ER' },
                    'EMP003': { name: 'Dr. Wanida Pongpan', dept: 'ER' },
                    'EMP004': { name: 'Nurse Suwan Thongdee', dept: 'ER' },
                    'EMP015': { name: 'Dr. Wichai Sukjai', dept: 'ICU' },
                    'EMP016': { name: 'Nurse Ploy Chai', dept: 'ICU' },
                    'EMP017': { name: 'Dr. Chai Wongsawat', dept: 'ICU' },
                    'EMP030': { name: 'Dr. Narong Kaewmala', dept: 'OR' },
                    'EMP031': { name: 'Nurse Mai Pong', dept: 'OR' },
                    'EMP032': { name: 'Dr. Krit Suk', dept: 'OR' },
                    'EMP045': { name: 'Nurse Apinya Wongsawat', dept: 'Ward' },
                    'EMP046': { name: 'Dr. Pong Chai', dept: 'Ward' },
                    'EMP047': { name: 'Nurse Joy Ploy', dept: 'Ward' }
                },
                departments: {
                    'ER': {
                        name: '‡πÅ‡∏ú‡∏ô‡∏Å ER (Emergency Room)',
                        stats: { avgScore: 62.8, passRate: 25.0, totalLogs: 39, rank: '#3/12' },
                        trend: [
                            { date: '30/10', score: 58.2 }, { date: '31/10', score: 60.5 },
                            { date: '01/11', score: 61.8 }, { date: '02/11', score: 59.3 },
                            { date: '03/11', score: 63.7 }, { date: '04/11', score: 65.2 },
                            { date: '05/11', score: 62.8 }
                        ],
                        staff: [
                            { id: 'EMP001', name: 'Dr. Somchai Ruangsri', score: 88.5, front: 90, back: 87, logs: 12, status: 'Pass' },
                            { id: 'EMP002', name: 'Nurse Pranee Sukjai', score: 80.2, front: 82, back: 78, logs: 10, status: 'Pass' },
                            { id: 'EMP003', name: 'Dr. Wanida Pongpan', score: 47.5, front: 50, back: 45, logs: 8, status: 'Fail' },
                            { id: 'EMP004', name: 'Nurse Suwan Thongdee', score: 35.2, front: 38, back: 32, logs: 9, status: 'Fail' }
                        ],
                        frontAvg: 65.0,
                        backAvg: 60.5
                    },
                    'ICU': {
                        name: '‡πÅ‡∏ú‡∏ô‡∏Å ICU (Intensive Care Unit)',
                        stats: { avgScore: 82.5, passRate: 66.7, totalLogs: 37, rank: '#1/12' },
                        trend: [
                            { date: '30/10', score: 78.5 }, { date: '31/10', score: 80.2 },
                            { date: '01/11', score: 81.8 }, { date: '02/11', score: 83.1 },
                            { date: '03/11', score: 84.5 }, { date: '04/11', score: 83.7 },
                            { date: '05/11', score: 82.5 }
                        ],
                        staff: [
                            { id: 'EMP015', name: 'Dr. Wichai Sukjai', score: 86.8, front: 88, back: 85, logs: 15, status: 'Pass' },
                            { id: 'EMP016', name: 'Nurse Ploy Chai', score: 82.5, front: 84, back: 81, logs: 12, status: 'Pass' },
                            { id: 'EMP017', name: 'Dr. Chai Wongsawat', score: 78.2, front: 80, back: 76, logs: 10, status: 'Fail' }
                        ],
                        frontAvg: 84.0,
                        backAvg: 80.7
                    },
                    'OR': {
                        name: '‡πÅ‡∏ú‡∏ô‡∏Å OR (Operating Room)',
                        stats: { avgScore: 93.1, passRate: 100.0, totalLogs: 39, rank: '#1/12' },
                        trend: [
                            { date: '30/10', score: 91.2 }, { date: '31/10', score: 92.5 },
                            { date: '01/11', score: 93.8 }, { date: '02/11', score: 94.1 },
                            { date: '03/11', score: 93.5 }, { date: '04/11', score: 92.8 },
                            { date: '05/11', score: 93.1 }
                        ],
                        staff: [
                            { id: 'EMP030', name: 'Dr. Narong Kaewmala', score: 95.3, front: 96, back: 94, logs: 14, status: 'Pass' },
                            { id: 'EMP031', name: 'Nurse Mai Pong', score: 92.8, front: 94, back: 91, logs: 13, status: 'Pass' },
                            { id: 'EMP032', name: 'Dr. Krit Suk', score: 91.2, front: 92, back: 90, logs: 12, status: 'Pass' }
                        ],
                        frontAvg: 94.0,
                        backAvg: 91.7
                    },
                    'Ward': {
                        name: '‡πÅ‡∏ú‡∏ô‡∏Å Ward (General Ward)',
                        stats: { avgScore: 68.8, passRate: 0.0, totalLogs: 28, rank: '#8/12' },
                        trend: [
                            { date: '30/10', score: 65.2 }, { date: '31/10', score: 66.8 },
                            { date: '01/11', score: 68.5 }, { date: '02/11', score: 69.7 },
                            { date: '03/11', score: 70.2 }, { date: '04/11', score: 69.5 },
                            { date: '05/11', score: 68.8 }
                        ],
                        staff: [
                            { id: 'EMP045', name: 'Nurse Apinya Wongsawat', score: 75.5, front: 78, back: 73, logs: 11, status: 'Fail' },
                            { id: 'EMP046', name: 'Dr. Pong Chai', score: 68.8, front: 71, back: 66, logs: 9, status: 'Fail' },
                            { id: 'EMP047', name: 'Nurse Joy Ploy', score: 62.1, front: 65, back: 59, logs: 8, status: 'Fail' }
                        ],
                        frontAvg: 71.3,
                        backAvg: 66.0
                    }
                }
            };

            // ============================================
            // HELPER FUNCTION: Map department name to ID
            // ============================================
            function mapDeptNameToId(deptParam) {
                if (!deptParam) return null;

                // First check direct mapping
                if (deptNameMapping[deptParam]) {
                    return deptNameMapping[deptParam];
                }

                // Check case-insensitive mapping
                const lowerParam = deptParam.toLowerCase();
                for (const [key, value] of Object.entries(deptNameMapping)) {
                    if (key.toLowerCase() === lowerParam) {
                        return value;
                    }
                }

                // Check if it's already a valid department ID
                if (database.departments[deptParam]) {
                    return deptParam;
                }

                // Default fallback to ER if no match found
                console.warn(`Department "${deptParam}" not found, defaulting to ER`);
                return 'ER';
            }

            // ============================================
            // GLOBAL VARIABLES
            // ============================================
            let deptTrendChart = null;
            let currentSource = null; // Track if user came from IC

            // ============================================
            // LOGIN HANDLER
            // ============================================
            function handleLogin() {
                const empInput = document.getElementById('empIdInput');
                const errorMsg = document.getElementById('errorMessage');
                if (!empInput) return;

                const empId = empInput.value.trim().toUpperCase();

                if (database.users[empId]) {
                    const user = database.users[empId];
                    sessionStorage.setItem('dept_authenticated', 'true');
                    sessionStorage.setItem('dept_empId', empId);
                    sessionStorage.setItem('dept_id', user.dept);

                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboardContent').style.display = 'block';
                    loadDashboard(user.dept);
                } else {
                    if (errorMsg) errorMsg.style.display = 'flex';
                    empInput.value = '';
                    empInput.focus();
                }
            }

            // ============================================
            // LOGOUT HANDLER - FIXED: Redirect to index.html
            // ============================================
            function handleLogout() {
                sessionStorage.clear();
                // Redirect to index.html to prevent auto-login loop
                window.location.href = 'index.html';
            }

            // ============================================
            // LOAD DASHBOARD DATA
            // ============================================
            function loadDashboard(deptId) {
                const deptData = database.departments[deptId];
                if (!deptData) {
                    console.error('Department data not found for:', deptId);
                    return;
                }

                console.log('Loading dashboard for:', deptId, deptData);

                // Update header
                const deptNameEl = document.getElementById('deptName');
                if (deptNameEl) deptNameEl.textContent = deptData.name;

                // Update KPIs
                const deptAvgEl = document.getElementById('deptAvg');
                const deptPassEl = document.getElementById('deptPass');
                const deptLogsEl = document.getElementById('deptLogs');
                const deptRankEl = document.getElementById('deptRank');

                if (deptAvgEl) deptAvgEl.textContent = deptData.stats.avgScore.toFixed(1) + '%';
                if (deptPassEl) deptPassEl.textContent = deptData.stats.passRate.toFixed(1) + '%';
                if (deptLogsEl) deptLogsEl.textContent = deptData.stats.totalLogs;

                // Update Status vs Target (Target = 85%)
                const deptStatusEl = document.getElementById('deptStatus');
                if (deptStatusEl) {
                    const TARGET = 85;
                    if (deptData.stats.avgScore >= TARGET) {
                        deptStatusEl.textContent = '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (On Track)';
                        deptStatusEl.style.color = 'var(--success)';
                    } else {
                        deptStatusEl.textContent = '‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Below Target)';
                        deptStatusEl.style.color = 'var(--danger)';
                    }
                }

                // Update comparison section
                const compAvgEl = document.getElementById('compAvg');
                const compPassEl = document.getElementById('compPass');
                const compLogsEl = document.getElementById('compLogs');

                if (compAvgEl) compAvgEl.textContent = deptData.stats.avgScore.toFixed(1) + '%';
                if (compPassEl) compPassEl.textContent = deptData.stats.passRate.toFixed(1) + '%';
                if (compLogsEl) compLogsEl.textContent = deptData.stats.totalLogs;

                // Update hand visualization
                const frontAvgEl = document.getElementById('frontAvg');
                const backAvgEl = document.getElementById('backAvg');
                if (frontAvgEl && deptData.frontAvg) frontAvgEl.textContent = deptData.frontAvg.toFixed(1);
                if (backAvgEl && deptData.backAvg) backAvgEl.textContent = deptData.backAvg.toFixed(1);

                // Render charts and tables
                renderTrendChart(deptData.trend);
                renderRankingsTable(deptData.staff);

                // Update Motivation Banner based on score - 5 Level Humanized System
                const motivationBanner = document.getElementById('motivationBanner');
                if (motivationBanner) {
                    const score = deptData.stats.avgScore;
                    motivationBanner.className = 'motivation-banner';

                    // 5-Level Humanized Thai Message System for Department (Team Spirit Context)
                    if (score >= 90) {
                        motivationBanner.classList.add('motivation-emerald');
                        motivationBanner.innerHTML = '<span class="banner-main-text">üèÜ Perfect !!! ‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏£‡πà‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö</span>';
                    } else if (score >= 75) {
                        motivationBanner.classList.add('motivation-ocean');
                        motivationBanner.innerHTML = '<span class="banner-main-text">‚ú® ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ !!! ‡∏°‡∏∑‡∏≠‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∞</span>';
                    } else if (score >= 60) {
                        motivationBanner.classList.add('motivation-amber');
                        motivationBanner.innerHTML = '<span class="banner-main-text">üëç ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏á‡∏¢‡∏≤‡∏Å‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏•‡πà‡∏∞</span>';
                    } else if (score >= 50) {
                        motivationBanner.classList.add('motivation-orange');
                        motivationBanner.innerHTML = '<span class="banner-main-text">‚ö†Ô∏è ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ !!! ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏•‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡∏π‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞!</span>';
                    } else {
                        motivationBanner.classList.add('motivation-crimson');
                        motivationBanner.innerHTML = '<span class="banner-main-text">üö® ‡∏£‡∏∞‡∏ß‡∏±‡∏á!!! ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ‡∏õ‡∏∞‡∏õ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>';
                    }
                }

                // ============================================
                // ZONE SCORES & TOOLTIP SETUP
                // ============================================
                const frontAvgValue = deptData.frontAvg || 50;
                const backAvgValue = deptData.backAvg || 50;

                const zoneScores = {
                    "Palm ‡∏ù‡πà‡∏≤‡∏°‡∏∑‡∏≠": frontAvgValue.toFixed(1) + "%",
                    "Paw ‡∏≠‡∏∏‡πâ‡∏á‡∏°‡∏∑‡∏≠": frontAvgValue.toFixed(1) + "%",
                    "Thumbs ‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á": frontAvgValue.toFixed(1) + "%",
                    "Pointer ‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏µ‡πâ": frontAvgValue.toFixed(1) + "%",
                    "Middle ‡∏ô‡∏¥‡πâ‡∏ß‡∏Å‡∏•‡∏≤‡∏á": frontAvgValue.toFixed(1) + "%",
                    "Backhand ‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏≠": backAvgValue.toFixed(1) + "%",
                    "Between ‡∏ã‡∏≠‡∏Å‡∏ô‡∏¥‡πâ‡∏ß": backAvgValue.toFixed(1) + "%",
                    "Nails ‡πÄ‡∏•‡πá‡∏ö": backAvgValue.toFixed(1) + "%",
                    "Pinky ‡∏ô‡∏¥‡πâ‡∏ß‡∏Å‡πâ‡∏≠‡∏¢": backAvgValue.toFixed(1) + "%"
                };

                // Helper function for color based on score
                function getScoreColor(score) {
                    if (score >= 70) return 'var(--success)';
                    if (score >= 30) return 'var(--warning)';
                    return 'var(--danger)';
                }

                // Setup tooltip event listeners
                const tooltip = document.getElementById('handTooltip');
                const handCard = document.getElementById('handProminentCard');

                document.querySelectorAll('.interactive-zone').forEach(zone => {
                    zone.addEventListener('mouseenter', (e) => {
                        const name = e.target.getAttribute('data-zone');
                        if (tooltip && zoneScores[name]) {
                            const scoreValue = parseFloat(zoneScores[name]);
                            const color = getScoreColor(scoreValue);
                            tooltip.innerHTML = `${name}: <span style="color:${color};font-weight:800;">${zoneScores[name]}</span>`;
                            tooltip.classList.add('visible');
                        }
                    });
                    zone.addEventListener('mousemove', (e) => {
                        if (tooltip && handCard) {
                            const rect = handCard.getBoundingClientRect();
                            tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
                            tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
                        }
                    });
                    zone.addEventListener('mouseleave', () => {
                        if (tooltip) {
                            tooltip.classList.remove('visible');
                        }
                    });
                });

                console.log('Dashboard loaded successfully');
            }

            // ============================================
            // RENDER TREND CHART
            // ============================================
            function renderTrendChart(trendData) {
                const canvas = document.getElementById('trendChart');
                if (!canvas) return;

                if (deptTrendChart) deptTrendChart.destroy();

                const ctx = canvas.getContext('2d');
                const labels = trendData.map(t => t.date);
                const scores = trendData.map(t => t.score);

                deptTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å (Dept Average %)',
                            data: scores,
                            borderColor: 'rgb(5, 150, 105)',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointBackgroundColor: 'rgb(5, 150, 105)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }, {
                            label: '‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ú‡πà‡∏≤‡∏ô (Pass Threshold 80%)',
                            data: Array(labels.length).fill(80),
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { callback: function (value) { return value + '%'; } }
                            }
                        }
                    }
                });
            }

            // ============================================
            // RENDER STAFF LIST TABLE (sorted by Name/ID)
            // ============================================
            function renderRankingsTable(staffData) {
                const tbody = document.getElementById('staffTableBody');
                if (!tbody) return;

                tbody.innerHTML = '';
                // Sort by name alphabetically instead of by score
                const sortedStaff = [...staffData].sort((a, b) => a.name.localeCompare(b.name));

                sortedStaff.forEach((emp) => {
                    const isPassed = emp.score >= 80;
                    const scoreColor = isPassed ? 'var(--success)' : 'var(--danger)';

                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';

                    // FIXED: Always pass source=ic when coming from IC dashboard
                    row.onclick = function () {
                        const sourceParam = currentSource === 'ic' ? 'ic' : 'dept';
                        window.location.href = 'personal-dashboard.html?id=' + emp.id + '&source=' + sourceParam;
                    };

                    row.innerHTML = `
                        <td style="padding: 14px; text-align: center; font-weight: 600;">${emp.id}</td>
                        <td style="padding: 14px; font-weight: 600;">${emp.name}</td>
                        <td style="padding: 14px; text-align: center; font-size: 16px; font-weight: 700; color: ${scoreColor};">
                            ${emp.score.toFixed(1)}%
                        </td>
                        <td style="padding: 14px; text-align: center; font-weight: 600;">${emp.front}%</td>
                        <td style="padding: 14px; text-align: center; font-weight: 600;">${emp.back}%</td>
                        <td style="padding: 14px; text-align: center;">${emp.logs}</td>
                        <td style="padding: 14px; text-align: center;">
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; background: ${isPassed ? '#d1fae5' : '#ffe4e6'}; color: ${scoreColor};">
                                ${isPassed ? '‚úì ‡∏ú‡πà‡∏≤‡∏ô (Pass)' : '‚úó ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (Fail)'}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // ============================================
            // SETUP BACK BUTTON
            // ============================================
            function setupBackButton() {
                const backContainer = document.getElementById('backButtonContainer');
                if (!backContainer) return;

                if (currentSource === 'ic') {
                    backContainer.style.display = 'block';
                    // Update button to go back to hospital dashboard
                    const backButton = backContainer.querySelector('button');
                    if (backButton) {
                        backButton.onclick = function () {
                            window.location.href = 'hospital-dashboard.html';
                        };
                    }
                } else {
                    backContainer.style.display = 'none';
                }
            }

            // ============================================
            // PAGE INITIALIZATION
            // ============================================
            document.addEventListener('DOMContentLoaded', function () {
                console.log('Department Dashboard Initializing...');

                // Step 1: Check URL parameters
                const params = new URLSearchParams(window.location.search);
                const source = params.get('source');
                const deptParam = params.get('dept');

                currentSource = source; // Store source globally

                // Step 2: Handle IC view (source=ic)
                if (source === 'ic' && deptParam) {
                    console.log('IC View detected, dept param:', deptParam);

                    // Map department name to ID
                    const deptId = mapDeptNameToId(deptParam);
                    console.log('Mapped to department ID:', deptId);

                    if (deptId && database.departments[deptId]) {
                        // Bypass login
                        sessionStorage.setItem('dept_authenticated', 'true');
                        sessionStorage.setItem('dept_id', deptId);

                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('dashboardContent').style.display = 'block';

                        // Setup back button for IC users
                        setupBackButton();

                        // Load dashboard data
                        loadDashboard(deptId);

                        console.log('IC View dashboard loaded for:', deptId);
                    } else {
                        console.error('Department not found after mapping:', deptParam, '->', deptId);
                        // Fallback: Show login screen
                        document.getElementById('loginScreen').style.display = 'flex';
                        document.getElementById('dashboardContent').style.display = 'none';
                    }
                }
                // Step 3: Handle normal authenticated session
                else {
                    const isAuth = sessionStorage.getItem('dept_authenticated');
                    const storedDept = sessionStorage.getItem('dept_id');

                    if (isAuth === 'true' && storedDept) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('dashboardContent').style.display = 'block';
                        loadDashboard(storedDept);
                    } else {
                        document.getElementById('loginScreen').style.display = 'flex';
                        document.getElementById('dashboardContent').style.display = 'none';
                    }
                }

                // Setup Enter key for login
                const empInput = document.getElementById('empIdInput');
                if (empInput) {
                    empInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') handleLogin();
                    });
                }

                console.log('Department Dashboard Initialized');
            });

        </script>
    </div>
</body>

</html>